<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Online Python Editor</title>

  <!-- PyScript Core -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.4.1/core.css" />
  <script type="module" src="https://pyscript.net/releases/2024.4.1/core.js"></script>

  <!-- External CSS -->
  <link rel="stylesheet" href="../static/css/styles.css" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet" />

  <!-- Ace Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.13/ace.js" crossorigin="anonymous"></script>
</head>

<body>
  <div class="page" id="editor-page">
    <!-- Sidebar: Logo and Examples -->
    <div class="sidebar">
      <div class="logo">
        <span class="logo-icon">üêç</span>
      </div>
      <div class="examples-container">
        <button class="example-btn" data-example="basic">Basic Example</button>
        <button class="example-btn" data-example="math">Math Example</button>
        <button class="example-btn" data-example="dictionary">Dictionary Example</button>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content">
      <section class="editor-section">
        <div id="editor"># Write your Python code here...</div>
        <button id="run-button">Run Code ‚ñ∂Ô∏è</button>
      </section>

      <section class="output-section">
        <h2>Output:</h2>
        <pre id="output"></pre>
      </section>
    </div>
  </div>

  <script type="py">
    from js import document, console, window
    from pyodide.ffi import create_proxy
    import io, sys, traceback, json

    # Kullanici email kontrol√º
    user_email = window.localStorage.getItem('user_email')
    if not user_email:
        window.location.href = 'login-signup.html'

    # Global state
    editor = None
    context = {"__builtins__": __builtins__}

    # 1. Ace edit√∂r√º ba≈ülat
    def init_editor():
        global editor
        if hasattr(window, "ace"):
            editor = window.ace.edit("editor")
            editor.setTheme("ace/theme/chrome")
            editor.session.setMode("ace/mode/python")
            editor.setFontSize(16)
            editor.renderer.setShowGutter(True)
            editor.setReadOnly(False)
            editor.focus()
            log_action("Eylem: A√ß")
            editor.container.addEventListener(
                "keydown", create_proxy(handle_keydown)
            )
        else:
            console.log("Ace editor not available.")

    # 2. √ñrnek kodlarƒ± y√ºkle
    examples = {
      "basic": '''print("Hello from the browser! üëã")
name = "Alice"
age = 28
print(f"{name} is {age} years old. Next year: {age+1}")''',
      "math": '''import math
radius = 5
print(f"Area: {math.pi * radius**2:.2f}")
print(f"Circumference: {2 * math.pi * radius**2:.2f}")''',
      "dictionary": '''student_grades = {"Math": 90, "Science": 85, "History": 88}
for subject, grade in student_grades.items():
    print(f"{subject.ljust(10)}: {'‚≠ê' * (grade // 10)}")'''
    }
    def load_example(event):
        example_id = event.target.getAttribute("data-example")
        code = examples.get(example_id, "")
        if editor:
            editor.setValue(code, -1)
            editor.focus()

    for btn in document.getElementsByClassName("example-btn"):
        btn.addEventListener("click", create_proxy(load_example))

    # 3. Tu≈ü basƒ±mlarƒ±nƒ± logla
    def handle_keydown(evt):
        key = evt.key
        act = f"Basƒ±lan Tu≈ü: {key if len(key)==1 else key.upper()}"
        log_action(act)

    # 4. Log entry olu≈ütur ve cache'e ekle hemen
    def log_action(action):
        ts = window.Date.new().toISOString()
        code = editor.getValue() if editor else ''
        entry = {
            "email": user_email,
            "time": ts,
            "action": action,
            "totalchars": len(code),
            "totallines": code.count("\n") + 1
        }
        pending = json.loads(window.localStorage.getItem('pending_logs') or '[]')
        pending.append(entry)
        window.localStorage.setItem('pending_logs', json.dumps(pending))
        console.log('Cached log:', json.dumps(entry))

    # 5. Cached log'larƒ± sunucuya g√∂nder
    def flush_to_server(event=None):
        pending = json.loads(window.localStorage.getItem('pending_logs') or '[]')
        if not pending:
            return
        payload = json.dumps(pending)
        promise = window.fetch("https://your-server.com/api/log", {
            "method": "POST",
            "headers": {"Content-Type": "application/json"},
            "body": payload
        })
        promise.then(lambda resp: window.localStorage.removeItem('pending_logs'))
        promise.catch(lambda err: console.log("Flush error:", err))

    # 6. Kod √ßalƒ±≈ütƒ±rma (no logging)
    def run_code(event):
        output_div = document.getElementById("output")
        old_stdout = sys.stdout
        new_stdout = io.StringIO()
        sys.stdout = new_stdout
        try:
            exec(editor.getValue(), context)
            output_div.textContent = new_stdout.getvalue()
        except Exception:
            output_div.textContent = traceback.format_exc()
        finally:
            sys.stdout = old_stdout

    # Event listener for run
    run_code_proxy = create_proxy(run_code)
    document.getElementById("run-button").addEventListener("click", run_code_proxy)

    # Ba≈ülat
    init_editor()
    # Her 10 dakikada bir g√∂nder
    window.setInterval(create_proxy(flush_to_server), 10 * 60 * 1000)
    # Sayfa kapanƒ±rken de cache'i sakla
    window.addEventListener('beforeunload', create_proxy(lambda e: None))
    
    </script>
</body>

</html>